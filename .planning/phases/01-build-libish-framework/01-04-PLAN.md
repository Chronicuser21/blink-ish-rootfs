---
phase: 01-build-libish-framework
plan: 04
type: execute
wave: 3
depends_on:
  - "03"
files_modified:
  - /Users/b/ish-ios/libiSHTest/AppDelegate.swift
  - /Users/b/ish-ios/libiSHTest/ViewController.swift
  - /Users/b/ish-ios/build-ios/libiSH.framework
autonomous: true
requirements: []
must_haves:
  truths:
    - "Test app can link framework and call initialization functions"
    - "Framework binary contains expected symbols"
  artifacts:
    - path: "ish-ios/libiSHTest/AppDelegate.swift"
      provides: "Test app entry point"
      min_lines: 20
    - path: "ish-ios/libiSHTest/ViewController.swift"
      provides: "Test app view with framework test"
      min_lines: 30
    - path: "ish-ios/build/Release-iphoneos/libiSH.framework"
      provides: "Built framework bundle"
      contains: "libiSH"
  key_links:
    - from: "libiSHTest"
      to: "libiSH.framework"
      via: "link"
      pattern: "iSHInitialize"
---

<objective>
Create test iOS app and verify framework builds correctly with expected symbols.

Purpose: Validate the framework works by building it and linking into a test app.
Output: Built framework, test app that successfully initializes the framework
</objective>

<execution_context>
@/Users/b/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/b/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-libish-framework/01-RESEARCH.md

# Prior plan outputs
@.planning/phases/01-build-libish-framework/01-03-SUMMARY.md

# Key source files
@/Users/b/ish-ios/libiSH/libiSH.h
</context>

<tasks>

<task type="auto">
  <name>Create test iOS app</name>
  <files>
    - /Users/b/ish-ios/libiSHTest/AppDelegate.swift
    - /Users/b/ish-ios/libiSHTest/ViewController.swift
  </files>
  <action>
Create a minimal iOS test app that links libiSH.framework and verifies it works.

Create `/Users/b/ish-ios/libiSHTest/AppDelegate.swift`:
```swift
import UIKit

@main
class AppDelegate: UIResponder, UIApplicationDelegate {
    var window: UIWindow?

    func application(_ application: UIApplication, 
                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        window = UIWindow(frame: UIScreen.main.bounds)
        window?.rootViewController = ViewController()
        window?.makeKeyAndVisible()
        return true
    }
}
```

Create `/Users/b/ish-ios/libiSHTest/ViewController.swift`:
```swift
import UIKit

class ViewController: UIViewController {
    var textView: UITextView!
    
    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .systemBackground
        
        textView = UITextView(frame: view.bounds)
        textView.isEditable = false
        textView.font = UIFont.monospacedSystemFont(ofSize: 14, weight: .regular)
        view.addSubview(textView)
        
        testFramework()
    }
    
    func testFramework() {
        var output = "Testing libiSH Framework\n\n"
        
        // Test 1: Initialize
        let initResult = iSHInitialize()
        output += "iSHInitialize(): \(initResult)\n"
        
        // Test 2: Check if framework is loaded
        output += "Framework loaded successfully!\n"
        
        // Note: Full testing requires a rootfs, which we don't have yet
        // That will be tested in Phase 3
        
        textView.text = output
    }
}
```

Create Xcode project for test app or add target to existing project. The test app should:
1. Link libiSH.framework
2. Call iSHInitialize() on launch
3. Display results in a text view
  </action>
  <verify>
    - `test -f /Users/b/ish-ios/libiSHTest/AppDelegate.swift` returns true
    - `test -f /Users/b/ish-ios/libiSHTest/ViewController.swift` returns true
    - `grep -c "iSHInitialize" /Users/b/ish-ios/libiSHTest/ViewController.swift` returns 1 or more
  </verify>
  <done>Test app exists and calls framework initialization</done>
</task>

<task type="auto">
  <name>Build framework and verify</name>
  <files>/Users/b/ish-ios/build-ios/libiSH.framework</files>
  <action>
Build the framework and verify it contains expected symbols:

```bash
cd /Users/b/ish-ios

# Build framework
xcodebuild -project libiSH.xcodeproj \
    -target libiSH \
    -configuration Release \
    -sdk iphoneos \
    ARCHS=arm64 \
    build

# Verify framework was created
ls -la build/Release-iphoneos/libiSH.framework/

# Check framework contains expected symbols
nm build/Release-iphoneos/libiSH.framework/libiSH | grep -E "iSHInitialize|iSHMountRoot|iSHPTYCreate"
```

If build fails, check:
1. Static libraries exist in build-ios/
2. Include paths are correct
3. SQLite framework is linked

Expected output:
- libiSH.framework bundle in build directory
- Framework contains arm64 binary
- Framework exports public symbols
  </action>
  <verify>
    - `test -d /Users/b/ish-ios/build/Release-iphoneos/libiSH.framework` returns true
    - `test -f /Users/b/ish-ios/build/Release-iphoneos/libiSH.framework/libiSH` returns true
    - `nm /Users/b/ish-ios/build/Release-iphoneos/libiSH.framework/libiSH 2>/dev/null | grep -c "iSHInitialize"` returns 1 or more
  </verify>
  <done>Framework builds successfully and contains expected symbols</done>
</task>

</tasks>

<verification>
1. Framework builds successfully for iOS arm64
2. Framework links all three static libraries
3. Framework exports public API symbols
4. Test app links framework successfully
</verification>

<success_criteria>
- [ ] libiSH.framework builds in Release configuration
- [ ] Framework contains libiSH binary with arm64 architecture
- [ ] nm shows public symbols (iSHInitialize, etc.)
- [ ] Test app project exists
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-libish-framework/01-04-SUMMARY.md`
</output>
