---
phase: 01-build-libish-framework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/b/ish-ios/libiSH.xcodeproj/project.pbxproj
  - /Users/b/ish-ios/libiSH/Info.plist
  - /Users/b/ish-ios/libiSH/libiSH.h
  - /Users/b/ish-ios/libiSH/iSHTypes.h
autonomous: true
requirements: []
must_haves:
  truths:
    - "Framework target exists in Xcode project"
    - "Public headers are visible to framework consumers"
    - "Framework builds without errors for iOS arm64"
  artifacts:
    - path: "ish-ios/libiSH.xcodeproj/project.pbxproj"
      provides: "Framework target configuration"
      contains: "libiSH"
    - path: "ish-ios/libiSH/libiSH.h"
      provides: "Public API umbrella header"
      min_lines: 30
    - path: "ish-ios/libiSH/iSHTypes.h"
      provides: "Type definitions for public API"
      min_lines: 20
  key_links:
    - from: "libiSH.h"
      to: "kernel/init.h"
      via: "#include wrapper"
      pattern: "mount_root|become_first_process"
---

<objective>
Create Xcode framework target structure with public API headers that expose iSH's initialization and PTY interfaces.

Purpose: Establish the framework packaging layer that will contain the static libraries. Define the public API that Blink will consume.
Output: libiSH.xcodeproj with framework target, public headers exposing mount_root, become_first_process, PTY APIs
</objective>

<execution_context>
@/Users/b/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/b/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-libish-framework/01-RESEARCH.md

# Key source files to reference
@/Users/b/ish-ios/kernel/init.h
@/Users/b/ish-ios/fs/tty.h
@/Users/b/ish-ios/kernel/task.h
@/Users/b/ish-ios/iSH.xcodeproj/project.pbxproj
</context>

<tasks>

<task type="auto">
  <name>Create libiSH framework target in Xcode project</name>
  <files>/Users/b/ish-ios/libiSH.xcodeproj/project.pbxproj</files>
  <action>
Create a new framework target in iSH.xcodeproj named "libiSH":
1. Create libiSH.xcodeproj directory inside ish-ios/ (separate project for cleaner separation)
2. Framework type: static framework (will link .a files later)
3. Platform: iOS
4. Architectures: arm64 (device) + arm64-sim (simulator for testing)
5. Deployment target: iOS 15.0 (matches Blink's minimum)
6. Create standard framework directory structure:
   - libiSH/Info.plist
   - libiSH/libiSH.h (umbrella header)
   - libiSH/iSHTypes.h (type definitions)
   - libiSH/Private/ directory (empty for now, will contain headers from Meson build)

Use xcodebuild or manually edit project.pbxproj. The framework target should NOT include any source files yet - those come from linking static libraries in plan 03.
  </action>
  <verify>
    - `ls -la /Users/b/ish-ios/libiSH.xcodeproj/` shows project exists
    - `xcodebuild -project /Users/b/ish-ios/libiSH.xcodeproj -list` shows libiSH target
    - `xcodebuild -project /Users/b/ish-ios/libiSH.xcodeproj -target libiSH -showBuildSettings | grep IPHONEOS_DEPLOYMENT_TARGET` shows 15.0
  </verify>
  <done>Framework target exists and builds an empty framework for iOS arm64</done>
</task>

<task type="auto">
  <name>Create public API header files</name>
  <files>
    - /Users/b/ish-ios/libiSH/libiSH.h
    - /Users/b/ish-ios/libiSH/iSHTypes.h
  </files>
  <action>
Create the public API headers that will expose iSH functionality to Blink:

1. **libiSH.h** (umbrella header) - Include this to get all public APIs:
```objc
// libiSH.h - Public API for iSH framework
#ifndef LIBISH_H
#define LIBISH_H

#import <Foundation/Foundation.h>
#import "iSHTypes.h"

NS_ASSUME_NONNULL_BEGIN

#pragma mark - Initialization

/// Initialize the iSH emulator. Must call once before any other functions.
/// @return 0 on success, negative errno on failure
int iSHInitialize(void);

/// Mount the root filesystem
/// @param path Path to the rootfs tarball or directory
/// @return 0 on success, negative errno on failure
int iSHMountRoot(const char *path);

/// Become the first process (init)
/// @return 0 on success, negative errno on failure
int iSHBecomeFirstProcess(void);

#pragma mark - Terminal I/O

/// Create a pseudo-terminal for I/O
/// @return Pointer to iSHPTY or NULL on failure
iSHPTYRef _Nullable iSHPTYCreate(void);

/// Write input to PTY (from terminal to emulator)
/// @param pty The PTY instance
/// @param data Input data
/// @param len Length of data
/// @return Bytes written or negative errno
ssize_t iSHPTYWriteInput(iSHPTYRef pty, const void *data, size_t len);

/// Read output from PTY (from emulator to terminal)
/// @param pty The PTY instance
/// @param buf Buffer to read into
/// @param len Buffer size
/// @return Bytes read or negative errno
ssize_t iSHPTYReadOutput(iSHPTYRef pty, void *buf, size_t len);

/// Set terminal window size
/// @param pty The PTY instance
/// @param cols Number of columns
/// @param rows Number of rows
void iSHPTYSetSize(iSHPTYRef pty, int cols, int rows);

/// Destroy a PTY instance
/// @param pty The PTY to destroy
void iSHPTYDestroy(iSHPTYRef pty);

#pragma mark - Process Management

/// Execute a command in the emulator
/// @param path Path to executable
/// @param argv Argument array (NULL-terminated)
/// @param envp Environment array (NULL-terminated)
/// @return 0 on success, negative errno on failure
int iSHExecute(const char *path, char *const argv[], char *const envp[]);

NS_ASSUME_NONNULL_END

#endif // LIBISH_H
```

2. **iSHTypes.h** - Type definitions:
```objc
// iSHTypes.h - Type definitions for libiSH
#ifndef ISHTYPES_H
#define ISHTYPES_H

#include <stddef.h>
#include <stdint.h>

#ifdef __cplusplus
extern "C" {
#endif

/// Opaque reference to a PTY instance
typedef struct iSHPTY *iSHPTYRef;

/// Terminal window size
typedef struct iSHWinSize {
    uint16_t rows;
    uint16_t cols;
    uint16_t xpixel;
    uint16_t ypixel;
} iSHWinSize;

/// Terminal attributes
typedef struct iSHTermios {
    uint32_t c_iflag;
    uint32_t c_oflag;
    uint32_t c_cflag;
    uint32_t c_lflag;
    uint8_t c_cc[19];
} iSHTermios;

#ifdef __cplusplus
}
#endif

#endif // ISHTYPES_H
```

These headers define a C API (not ObjC) for maximum compatibility. The actual implementation will bridge to the internal C functions in kernel/init.h and fs/tty.h.
  </action>
  <verify>
    - `cat /Users/b/ish-ios/libiSH/libiSH.h | grep -c "iSHInitialize\|iSHMountRoot\|iSHPTYCreate"` returns 3 or more
    - `cat /Users/b/ish-ios/libiSH/iSHTypes.h | grep -c "iSHPTYRef\|iSHWinSize"` returns 2 or more
  </verify>
  <done>Public API headers exist and declare initialization, PTY, and process management functions</done>
</task>

</tasks>

<verification>
1. Framework target exists in libiSH.xcodeproj
2. Framework builds empty framework for iOS arm64 (no source files yet)
3. Public headers declare mount_root, become_first_process, PTY APIs
4. Headers use C linkage for maximum compatibility
</verification>

<success_criteria>
- [ ] libiSH.xcodeproj exists with framework target
- [ ] Framework target configured for iOS arm64
- [ ] libiSH.h declares all public functions
- [ ] iSHTypes.h declares required types
- [ ] Empty framework builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-libish-framework/01-01-SUMMARY.md`
</output>
