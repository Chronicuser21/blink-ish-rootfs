---
phase: 01-build-libish-framework
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/b/ish-ios/meson_ios_arm64.build
  - /Users/b/ish-ios/scripts/build-ios-framework.sh
  - /Users/b/ish-ios/meson_options.txt
autonomous: true
requirements: []
must_haves:
  truths:
    - "Meson builds three static libraries for iOS arm64"
    - "libish.a, libish_emu.a, libfakefs.a exist in build directory"
    - "Libraries contain arm64 architecture symbols"
  artifacts:
    - path: "ish-ios/build-ios/libish.a"
      provides: "Kernel/syscall layer"
      min_size: 500000
    - path: "ish-ios/build-ios/libish_emu.a"
      provides: "x86 emulation engine"
      min_size: 200000
    - path: "ish-ios/build-ios/libfakefs.a"
      provides: "SQLite-backed filesystem"
      min_size: 50000
  key_links:
    - from: "meson.build"
      to: "libish.a, libish_emu.a, libfakefs.a"
      via: "meson compile"
      pattern: "static_library"
---

<objective>
Configure Meson cross-compilation to build iSH's three static libraries for iOS arm64 architecture.

Purpose: Produce the core static libraries that will be linked into the framework. These libraries contain the x86 emulator, syscall translator, and filesystem implementation.
Output: libish.a, libish_emu.a, libfakefs.a compiled for iOS arm64
</objective>

<execution_context>
@/Users/b/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/b/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-libish-framework/01-RESEARCH.md

# Key source files
@/Users/b/ish-ios/meson.build
@/Users/b/ish-ios/meson_options.txt
</context>

<tasks>

<task type="auto">
  <name>Create iOS cross-compilation Meson configuration</name>
  <files>/Users/b/ish-ios/meson_ios_arm64.build</files>
  <action>
Create a Meson cross-compilation file for iOS arm64. This tells Meson how to compile for iOS using Xcode's toolchain.

Create `/Users/b/ish-ios/meson_ios_arm64.build`:
```ini
[binaries]
c = '/usr/bin/clang'
ar = '/usr/bin/ar'
strip = '/usr/bin/strip'

[host_machine]
system = 'ios'
cpu_family = 'arm64'
cpu = 'arm64'
endian = 'little'

[properties]
c_args = [
    '-target', 'arm64-apple-ios15.0',
    '-isysroot', '/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk',
    '-fembed-bitcode',
    '-O2',
]
c_link_args = [
    '-target', 'arm64-apple-ios15.0',
    '-isysroot', '/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk',
]
```

Also need a simulator version for testing. Create `/Users/b/ish-ios/meson_ios_sim.build`:
```ini
[binaries]
c = '/usr/bin/clang'
ar = '/usr/bin/ar'
strip = '/usr/bin/strip'

[host_machine]
system = 'ios'
cpu_family = 'arm64'
cpu = 'arm64'
endian = 'little'

[properties]
c_args = [
    '-target', 'arm64-apple-ios15.0-simulator',
    '-isysroot', '/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk',
    '-O2',
]
c_link_args = [
    '-target', 'arm64-apple-ios15.0-simulator',
    '-isysroot', '/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk',
]
```

Note: The actual SDK path may vary. Use `xcrun --sdk iphoneos --show-sdk-path` to get the correct path.
  </action>
  <verify>
    - `test -f /Users/b/ish-ios/meson_ios_arm64.build` returns true
    - `grep -c "arm64-apple-ios" /Users/b/ish-ios/meson_ios_arm64.build` returns 2 or more
  </verify>
  <done>Meson cross-compilation files exist for iOS device and simulator</done>
</task>

<task type="auto">
  <name>Create build script for iOS framework</name>
  <files>/Users/b/ish-ios/scripts/build-ios-framework.sh</files>
  <action>
Create a build script that:
1. Sets up Meson build directory for iOS arm64
2. Compiles the three static libraries
3. Outputs to a known location

Create `/Users/b/ish-ios/scripts/build-ios-framework.sh`:
```bash
#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
BUILD_DIR="${SCRIPT_DIR}/build-ios"

# Get SDK paths
IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
SIM_SDK_PATH=$(xcrun --sdk iphonesimulator --show-sdk-path)

echo "iOS SDK: $IOS_SDK_PATH"
echo "Sim SDK: $SIM_SDK_PATH"

# Update cross-compilation files with actual SDK paths
sed -i.bak "s|/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk|$IOS_SDK_PATH|g" "$SCRIPT_DIR/meson_ios_arm64.build"
sed -i.bak "s|/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk|$SIM_SDK_PATH|g" "$SCRIPT_DIR/meson_ios_sim.build"

# Build for iOS device (arm64)
echo "Building for iOS arm64..."
rm -rf "$BUILD_DIR"
meson setup "$BUILD_DIR" "$SCRIPT_DIR" \
    --cross-file "$SCRIPT_DIR/meson_ios_arm64.build" \
    --default-library static \
    -Dkernel=ish \
    -Dengine=asbestos

ninja -C "$BUILD_DIR" libish.a libish_emu.a libfakefs.a

echo "Build complete. Libraries in: $BUILD_DIR"
ls -la "$BUILD_DIR"/*.a
```

Make executable: `chmod +x /Users/b/ish-ios/scripts/build-ios-framework.sh`
  </action>
  <verify>
    - `test -x /Users/b/ish-ios/scripts/build-ios-framework.sh` returns true
    - `grep -c "meson setup" /Users/b/ish-ios/scripts/build-ios-framework.sh` returns 1
  </verify>
  <done>Build script exists and is executable</done>
</task>

<task type="auto">
  <name>Execute Meson build for iOS arm64</name>
  <files>
    - /Users/b/ish-ios/build-ios/libish.a
    - /Users/b/ish-ios/build-ios/libish_emu.a
    - /Users/b/ish-ios/build-ios/libfakefs.a
  </files>
  <action>
Run the build script to compile the static libraries:

```bash
cd /Users/b/ish-ios
./scripts/build-ios-framework.sh
```

Expected output:
- libish.a (~500KB-1MB) - Contains kernel, syscall translation, filesystem
- libish_emu.a (~200-500KB) - Contains x86 emulation (emu/, asbestos/)
- libfakefs.a (~50-100KB) - Contains SQLite-backed filesystem

After build, verify libraries contain arm64 symbols:
```bash
lipo -info build-ios/libish.a
# Should show: Architectures in the fat file: build-ios/libish.a are: arm64
# Or for thin library: Non-fat file: build-ios/libish.a is architecture: arm64

nm build-ios/libish.a | grep "mount_root\|become_first_process"
# Should show symbols
```

Note: If build fails due to missing dependencies, ensure SQLite3 and other dependencies are available:
```bash
brew install sqlite
```
  </action>
  <verify>
    - `test -f /Users/b/ish-ios/build-ios/libish.a` returns true
    - `test -f /Users/b/ish-ios/build-ios/libish_emu.a` returns true
    - `test -f /Users/b/ish-ios/build-ios/libfakefs.a` returns true
    - `nm /Users/b/ish-ios/build-ios/libish.a | grep -c "mount_root"` returns 1 or more
    - File sizes are reasonable: `ls -la /Users/b/ish-ios/build-ios/*.a | awk '{sum+=$5} END {print sum}'` should be > 500000
  </verify>
  <done>All three static libraries exist and contain expected symbols</done>
</task>

</tasks>

<verification>
1. Meson cross-compilation files exist for iOS arm64 and simulator
2. Build script exists and is executable
3. Build completes without errors
4. All three static libraries exist with correct architecture
5. Libraries contain expected symbols (mount_root, become_first_process, etc.)
</verification>

<success_criteria>
- [ ] meson_ios_arm64.build exists with correct SDK paths
- [ ] build-ios-framework.sh is executable
- [ ] libish.a exists and is arm64 architecture
- [ ] libish_emu.a exists and is arm64 architecture
- [ ] libfakefs.a exists and is arm64 architecture
- [ ] All libraries contain expected symbols
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-libish-framework/01-02-SUMMARY.md`
</output>
