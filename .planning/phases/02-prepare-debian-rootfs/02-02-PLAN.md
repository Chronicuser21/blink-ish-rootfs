---
phase: 02-prepare-debian-rootfs
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - rootfs/.gitignore
  - blink-shell/Resources/debian10-ish/
  - blink-shell/blink-iSH.xcodeproj/project.pbxproj
autonomous: false
requirements: []

must_haves:
  truths:
    - "Build completes successfully in GitHub Actions"
    - "Artifact debian10-ish-rootfs is downloadable"
    - "Extracted rootfs contains data/ directory and meta.db"
    - "Rootfs size is under 100MB compressed"
    - "Rootfs imports into iSH app without errors"
    - "apt update succeeds in iSH"
    - "Rootfs bundled in blink-shell/Resources/debian10-ish/"
    - "Xcode project includes rootfs in app bundle"
  artifacts:
    - path: "rootfs/.gitignore"
      provides: "Git tracking for large artifacts"
      contains: "debian10-ish/"
    - path: "debian10-ish/data/"
      provides: "File content storage"
      exists_after: "build completion"
    - path: "debian10-ish/meta.db"
      provides: "SQLite metadata"
      exists_after: "build completion"
    - path: "blink-shell/Resources/debian10-ish/"
      provides: "Bundled rootfs for app distribution"
      exists_after: "bundling task"
    - path: "blink-shell/blink-iSH.xcodeproj/project.pbxproj"
      provides: "Xcode project configuration"
      contains: "debian10-ish"
  key_links:
    - from: "GitHub Actions artifact"
      to: "local filesystem"
      via: "gh run download or browser download"
      pattern: "debian10-ish/"
    - from: "debian10-ish/"
      to: "iSH app"
      via: "iSH import functionality"
      pattern: "import filesystem"
    - from: "debian10-ish/"
      to: "blink-shell/Resources/"
      via: "cp -r command"
      pattern: "Resources/debian10-ish"
    - from: "blink-shell/Resources/debian10-ish/"
      to: "app bundle"
      via: "Xcode folder reference"
      pattern: "folder reference"
---

<objective>
Trigger the CI/CD build, download the rootfs artifact, and verify it works in iSH.

Purpose: Confirm the build pipeline produces a working rootfs that can be imported into iSH.
Output: Verified debian10-ish rootfs ready for bundling in Blink-iSH.
</objective>

<execution_context>
@/Users/b/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/b/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/b/.planning/PROJECT.md
@/Users/b/.planning/ROADMAP.md
@/Users/b/.planning/STATE.md
@/Users/b/.planning/phases/02-prepare-debian-rootfs/02-CONTEXT.md
@/Users/b/.planning/phases/02-prepare-debian-rootfs/02-RESEARCH.md

# Prior plan output
@/Users/b/.planning/phases/02-prepare-debian-rootfs/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Commit and push build pipeline</name>
  <files>
    - .github/workflows/build-rootfs.yml
    - rootfs/build/Dockerfile
    - rootfs/scripts/debootstrap.sh
    - rootfs/scripts/configure.sh
    - rootfs/scripts/convert.sh
    - rootfs/.gitignore
  </files>
  <action>
1. Create `rootfs/.gitignore` to exclude build artifacts:
   ```
   # Build outputs
   debian10-ish/
   *.tar.gz
   /output/
   ```

2. Commit all build pipeline files with message:
   `feat(rootfs): add CI/CD pipeline for Debian 10 i386 rootfs`

3. Push to remote to trigger GitHub Actions workflow.

4. Monitor workflow at: `https://github.com/<owner>/<repo>/actions`

Wait for build to complete (typically 5-10 minutes).
  </action>
  <verify>
    - Git commit created
    - Push successful
    - GitHub Actions workflow started
  </verify>
  <done>Build pipeline committed and pushed, workflow running</done>
</task>

<task type="auto">
  <name>Download and verify artifact</name>
  <files>debian10-ish/ (downloaded)</files>
  <action>
After GitHub Actions workflow completes:

1. Download artifact using one of:
   - `gh run download --name debian10-ish-rootfs` (if gh CLI available)
   - Browser download from Actions run page

2. Extract and verify structure:
   ```bash
   ls -la debian10-ish/
   # Should show: data/ and meta.db
   
   ls debian10-ish/data/ | wc -l
   # Should show 1000+ files/directories (minimal Debian)
   
   du -sh debian10-ish/
   # Should be under 100MB
   
   file debian10-ish/meta.db
   # Should show: SQLite 3.x database
   ```

3. Verify meta.db contains expected tables:
   ```bash
   sqlite3 debian10-ish/meta.db ".tables"
   # Should show: meta, stats, paths
   ```

Do NOT proceed to checkpoint if any verification fails.
  </action>
  <verify>
    - debian10-ish/ directory exists with data/ and meta.db
    - meta.db is valid SQLite database
    - data/ contains file content (not empty)
    - Total size under 100MB
  </verify>
  <done>Artifact downloaded and structure verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Debian 10 i386 rootfs in fakefs format ready for iSH import. The rootfs was built via GitHub Actions CI/CD pipeline and contains:
- Minimal package set: apt, dpkg, bash, coreutils, grep, sed, awk
- Configured apt sources pointing to archive.debian.org
- Pre-converted to fakefs format (data/ + meta.db)
  </what-built>
  <how-to-verify>
**Prerequisites:** iSH app installed on iOS device (from App Store or TestFlight)

**Import steps:**
1. Transfer `debian10-ish/` directory to iOS device (AirDrop, iCloud Drive, or Files app)
2. Open iSH app
3. Tap gear icon → Filesystems → Import
4. Select the `debian10-ish` folder
5. Wait for import to complete

**Verify functionality:**
1. In iSH, run: `apt update`
   - Should succeed with "Reading package lists... Done"
   
2. Run: `apt install vim` (or any small package)
   - Should download and install successfully
   
3. Run: `vim --version | head -1`
   - Should show vim version

If apt update fails with 404 errors, the sources.list may be incorrect.
If package install fails, check network connectivity.
  </how-to-verify>
  <resume-signal>Type "approved" if import and apt work, or describe any issues encountered</resume-signal>
</task>

<task type="auto">
  <name>Bundle rootfs in Blink-iSH project</name>
  <files>
    - blink-shell/Resources/debian10-ish/
    - blink-shell/blink-iSH.xcodeproj/project.pbxproj
  </files>
  <action>
After user approves rootfs verification, bundle it into the Blink-iSH Xcode project:

1. Copy the verified rootfs to the project resources:
   ```bash
   cp -r debian10-ish/ blink-shell/Resources/debian10-ish/
   ```

2. Add the rootfs folder to the Xcode project:
   - Open `blink-shell/blink-iSH.xcodeproj`
   - Right-click Resources group → Add Files to "blink-iSH"
   - Select the `debian10-ish` folder
   - Check "Create folder references" (not "Create groups")
   - Check "Copy items into destination group's folder" if prompted
   - Add to target: blink-iSH

3. Verify the folder is added as a folder reference (blue folder icon, not yellow group).

4. The bundled rootfs will be included in the app bundle at runtime at:
   `Bundle.main.resourceURL?.appendingPathComponent("debian10-ish")`

Do NOT commit the rootfs files yet - just add them to the Xcode project. A later phase will handle versioning and updates.
  </action>
  <verify>
    - debian10-ish/ exists in blink-shell/Resources/
    - Xcode project shows debian10-ish as folder reference (blue icon)
    - Build succeeds with rootfs included in app bundle
  </verify>
  <done>Rootfs bundled in Xcode project resources, ready for app distribution</done>
</task>

</tasks>

<verification>
1. GitHub Actions workflow completed successfully
2. Artifact downloaded and extracted
3. Rootfs structure valid (data/ + meta.db)
4. Size under 100MB
5. Import into iSH successful
6. apt update and apt install work
7. Rootfs copied to blink-shell/Resources/debian10-ish/
8. Xcode project includes rootfs as folder reference
9. Build succeeds with bundled rootfs
</verification>

<success_criteria>
- Build pipeline runs successfully in GitHub Actions
- debian10-ish rootfs artifact downloadable
- Rootfs imports into iSH without errors
- apt commands work in iSH
- Rootfs bundled in blink-shell/Resources/debian10-ish/
- Xcode project includes rootfs as folder reference
- Rootfs ready for app distribution
</success_criteria>

<output>
After completion, create `.planning/phases/02-prepare-debian-rootfs/02-02-SUMMARY.md`
</output>
