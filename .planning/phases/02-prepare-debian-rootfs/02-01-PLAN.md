---
phase: 02-prepare-debian-rootfs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/build-rootfs.yml
  - rootfs/build/Dockerfile
  - rootfs/scripts/debootstrap.sh
  - rootfs/scripts/configure.sh
  - rootfs/scripts/convert.sh
autonomous: true
requirements: []

must_haves:
  truths:
    - "GitHub Actions workflow triggers on push to rootfs/**"
    - "Dockerfile builds successfully with docker build"
    - "debootstrap script creates i386 rootfs with correct architecture"
    - "configure script sets archive.debian.org sources"
    - "convert script produces fakefs format output"
  artifacts:
    - path: ".github/workflows/build-rootfs.yml"
      provides: "CI/CD automation"
      contains: "jobs:"
      min_lines: 40
    - path: "rootfs/build/Dockerfile"
      provides: "Build environment definition"
      contains: "FROM debian:"
      min_lines: 30
    - path: "rootfs/scripts/debootstrap.sh"
      provides: "Rootfs creation"
      contains: "--arch=i386"
    - path: "rootfs/scripts/configure.sh"
      provides: "Apt source configuration"
      contains: "archive.debian.org"
    - path: "rootfs/scripts/convert.sh"
      provides: "Fakefs conversion"
      contains: "fakefsify"
  key_links:
    - from: "rootfs/build/Dockerfile"
      to: "rootfs/scripts/"
      via: "COPY and RUN commands"
      pattern: "COPY.*scripts|RUN.*\\.sh"
    - from: ".github/workflows/build-rootfs.yml"
      to: "rootfs/build/Dockerfile"
      via: "docker build command"
      pattern: "docker build"
---

<objective>
Create the complete CI/CD build pipeline for generating a minimal Debian 10 i386 rootfs converted to iSH's fakefs format.

Purpose: Enable reproducible rootfs builds via GitHub Actions without requiring local Linux.
Output: Dockerfile, shell scripts, and workflow for automated rootfs generation.
</objective>

<execution_context>
@/Users/b/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/b/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/b/.planning/PROJECT.md
@/Users/b/.planning/ROADMAP.md
@/Users/b/.planning/STATE.md
@/Users/b/.planning/phases/02-prepare-debian-rootfs/02-CONTEXT.md
@/Users/b/.planning/phases/02-prepare-debian-rootfs/02-RESEARCH.md

# Existing iSH fakefsify source (reference for build)
@/Users/b/ish-ios/tools/fakefsify.c
@/Users/b/ish-ios/tools/fakefs.c
@/Users/b/ish-ios/tools/meson.build
</context>

<tasks>

<task type="auto">
  <name>Create GitHub Actions workflow</name>
  <files>.github/workflows/build-rootfs.yml</files>
  <action>
Create a GitHub Actions workflow that:
1. Triggers on push to `rootfs/**` paths and manual workflow_dispatch
2. Runs on `ubuntu-latest`
3. Builds Docker image from `rootfs/build/Dockerfile`
4. Extracts artifacts from container using `docker create` and `docker cp`
5. Uploads `debian10-ish/` directory as artifact named `debian10-ish-rootfs`

Reference iSH's CI workflow at `/Users/b/ish-ios/.github/workflows/ci.yml` for Docker/build patterns.
Use `actions/checkout@v4` and `actions/upload-artifact@v4`.

Do NOT run the build locally - just create the workflow file.
  </action>
  <verify>
    - File exists at .github/workflows/build-rootfs.yml
    - Contains `on:` trigger with `push` and `workflow_dispatch`
    - Contains `docker build` command
    - Contains `actions/upload-artifact@v4`
  </verify>
  <done>Workflow file created with proper triggers, build steps, and artifact upload</done>
</task>

<task type="auto">
  <name>Create multi-stage Dockerfile</name>
  <files>rootfs/build/Dockerfile</files>
  <action>
Create a multi-stage Dockerfile with these stages:

**Stage 1 (builder):** Debian Bookworm base
- Install: debootstrap, libarchive-dev, sqlite3, meson, ninja-build, git
- Clone ish-ios repo (shallow clone) for fakefsify source
- Build fakefsify from source using meson (reference `/Users/b/ish-ios/tools/meson.build`)
- Run debootstrap to create rootfs at `/rootfs`
- Configure apt sources for archive.debian.org

**Stage 2 (converter):** 
- Copy rootfs from builder
- Copy fakefsify binary from builder
- Create tarball from rootfs
- Run fakefsify to create `/output/debian10-ish/`

Key debootstrap command (i386 on x86_64 - no QEMU needed):
```bash
debootstrap --arch=i386 --variant=minbase --include=apt,dpkg,bash,coreutils,grep,sed,awk buster /rootfs http://archive.debian.org/debian
```

Apt sources must use archive.debian.org (buster is EOL):
```
deb http://archive.debian.org/debian buster main
deb http://archive.debian.org/debian-security buster/updates main
```

Do NOT include man-db in packages (causes long delays on iSH).
  </action>
  <verify>
    - File exists at rootfs/build/Dockerfile
    - Contains `FROM debian:` (multi-stage)
    - Contains `debootstrap` command with `--arch=i386`
    - Contains `archive.debian.org` for apt sources
    - Contains `fakefsify` conversion step
  </verify>
  <done>Multi-stage Dockerfile with debootstrap, fakefsify build, and conversion pipeline</done>
</task>

<task type="auto">
  <name>Create build scripts</name>
  <files>
    - rootfs/scripts/debootstrap.sh
    - rootfs/scripts/configure.sh
    - rootfs/scripts/convert.sh
  </files>
  <action>
Create three shell scripts that are called by the Dockerfile:

**debootstrap.sh:**
- Run debootstrap with: `--arch=i386 --variant=minbase --include=apt,dpkg,bash,coreutils,grep,sed,awk`
- Target: `buster` (Debian 10)
- Output: `/rootfs`
- Mirror: `http://archive.debian.org/debian`
- Exit on error, log progress

**configure.sh:**
- Configure `/rootfs/etc/apt/sources.list` with archive.debian.org
- Create `/rootfs/etc/apt/apt.conf.d/99no-cache` to disable caching
- Create `/rootfs/etc/apt/apt.conf.d/99no-install-recommends` to minimize size
- Run `apt-get clean` inside chroot to remove cache
- Exit on error

**convert.sh:**
- Create tarball: `tar -czf /tmp/rootfs.tar.gz -C /rootfs .`
- Run fakefsify: `fakefsify /tmp/rootfs.tar.gz /output/debian10-ish`
- Verify output has `data/` directory and `meta.db` file
- Exit on error

All scripts should be executable (`set -e` at top for error handling).
  </action>
  <verify>
    - All three scripts exist and are executable
    - debootstrap.sh contains `--arch=i386`
    - configure.sh contains `archive.debian.org`
    - convert.sh contains `fakefsify` and output verification
  </verify>
  <done>Three shell scripts for debootstrap, configuration, and fakefs conversion</done>
</task>

</tasks>

<verification>
1. All files exist in correct locations
2. Dockerfile syntax is valid (check with `docker build --no-cache --target builder rootfs/build/` if Docker available, or just validate syntax)
3. Shell scripts have proper error handling (`set -e`)
4. No hardcoded secrets or credentials
</verification>

<success_criteria>
- .github/workflows/build-rootfs.yml created with proper triggers
- Multi-stage Dockerfile builds debootstrap rootfs and converts to fakefs
- All three scripts created with correct Debian 10 i386 configuration
- Files ready for git commit
</success_criteria>

<output>
After completion, create `.planning/phases/02-prepare-debian-rootfs/02-01-SUMMARY.md`
</output>
